!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.GLTFUtils=t():e.GLTFUtils=t()}("undefined"!=typeof self?self:this,(function(){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(r,i,function(t){return e[t]}.bind(null,i));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t,n){"use strict";n.r(t),n.d(t,"GLTFAsset",(function(){return i})),n.d(t,"Scene",(function(){return I})),n.d(t,"Node",(function(){return O})),n.d(t,"Mesh",(function(){return S})),n.d(t,"Material",(function(){return C})),n.d(t,"Texture",(function(){return N})),n.d(t,"Vertex",(function(){return M})),n.d(t,"Skin",(function(){return R})),n.d(t,"Animation",(function(){return A})),n.d(t,"Vector3",(function(){return s})),n.d(t,"Quaternion",(function(){return a})),n.d(t,"Matrix",(function(){return y})),n.d(t,"Matrix3x3",(function(){return g})),n.d(t,"Matrix4x4",(function(){return _})),n.d(t,"glTFAssetFromTHREE",(function(){return L})),n.d(t,"AlphaMode",(function(){return m})),n.d(t,"ComponentType",(function(){return h})),n.d(t,"DataType",(function(){return l})),n.d(t,"MeshMode",(function(){return p})),n.d(t,"RGBColor",(function(){return x})),n.d(t,"RGBAColor",(function(){return E})),n.d(t,"VertexColorMode",(function(){return T})),n.d(t,"WrappingMode",(function(){return d})),n.d(t,"InterpolationMode",(function(){return w})),n.d(t,"TRSMode",(function(){return b})),n.d(t,"ImageOutputType",(function(){return c})),n.d(t,"BufferOutputType",(function(){return f})),n.d(t,"Buffer",(function(){return V})),n.d(t,"BufferView",(function(){return G})),n.d(t,"exportGLTF",(function(){return $})),n.d(t,"exportGLTFZip",(function(){return ee})),n.d(t,"exportGLB",(function(){return te}));var r,i=function(){function e(){this.copyright="",this.defaultScene=0,this.generator="glTF-js-utils",this._scenes=[]}return e.prototype.setDefaultScene=function(e){if("number"==typeof e)this.defaultScene=e;else{var t=this._scenes.indexOf(e);if(-1===t)throw new Error("Scene passed to setDefaultScene was not found.");this.defaultScene=t}},e.prototype.addScene=function(e){if(this._scenes.indexOf(e)>=0)throw new Error("Scene passed to addScene was added prior.");this._scenes.push(e)},e.prototype.removeScene=function(e){var t=this._scenes.indexOf(e);t>=0&&this._scenes.splice(t,1)},e.prototype.forEachScene=function(e){this._scenes.forEach(e)},e}(),o=(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)},function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),s=function(){function e(e,t,n){this.x=0,this.y=0,this.z=0,this.x=e,this.y=t,this.z=n}return e.prototype.toArray=function(){return[this.x,this.y,this.z]},e}(),a=function(){function e(e,t,n,r){this.x=e,this.y=t,this.z=n,this.w=r}return e.prototype.toArray=function(){return[this.x,this.y,this.z,this.w]},e}();function u(e){return e*Math.PI/180}var f,c,h,l,p,d,m,y=function(){function e(t){void 0===t&&(t=4),this.data=e.Identity(t)}return Object.defineProperty(e.prototype,"m",{get:function(){return this.data},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rows",{get:function(){return this.data.length},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"cols",{get:function(){return 0===this.rows?0:this.data[0].length},enumerable:!0,configurable:!0}),e.Identity=function(e){for(var t=[],n=0;n<e;++n){for(var r=[],i=0;i<e;++i)r.push(n===i?1:0);t.push(r)}return t},e.IsIdentity=function(e){var t=e.rows,n=e.cols;if(t!==n)return!1;for(var r=0;r<t;++r)for(var i=0;i<n;++i)if(e.data[r][i]!=(r===i?1:0))return!1;return!0},e}(),g=function(e){function t(){return e.call(this,3)||this}return o(t,e),t.Identity=function(){return y.Identity(3)},t.IsIdentity=function(e){return 3===e.rows&&3===e.cols&&y.IsIdentity(e)},t}(y),_=function(e){function t(){return e.call(this,4)||this}return o(t,e),t.Identity=function(){return y.Identity(4)},t.IsIdentity=function(e){return 4===e.rows&&4===e.cols&&y.IsIdentity(e)},t}(y),v=function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();!function(e){e[e.External=0]="External",e[e.DataURI=1]="DataURI",e[e.GLB=2]="GLB"}(f||(f={})),function(e){e[e.External=0]="External",e[e.DataURI=1]="DataURI",e[e.GLB=2]="GLB"}(c||(c={})),function(e){e[e.BYTE=5120]="BYTE",e[e.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",e[e.SHORT=5122]="SHORT",e[e.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",e[e.UNSIGNED_INT=5125]="UNSIGNED_INT",e[e.FLOAT=5126]="FLOAT"}(h||(h={})),function(e){e.SCALAR="SCALAR",e.VEC2="VEC2",e.VEC3="VEC3",e.VEC4="VEC4",e.MAT2="MAT2",e.MAT3="MAT3",e.MAT4="MAT4"}(l||(l={})),function(e){e[e.POINTS=0]="POINTS",e[e.LINES=1]="LINES",e[e.LINE_LOOP=2]="LINE_LOOP",e[e.LINE_STRIP=3]="LINE_STRIP",e[e.TRIANGLES=4]="TRIANGLES",e[e.TRIANGLE_STRIP=5]="TRIANGLE_STRIP",e[e.TRIANGLE_FAN=6]="TRIANGLE_FAN"}(p||(p={})),function(e){e[e.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",e[e.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",e[e.REPEAT=10497]="REPEAT"}(d||(d={})),function(e){e.OPAQUE="OPAQUE",e.MASK="MASK",e.BLEND="BLEND"}(m||(m={}));var T,w,b,x=function(){this.r=1,this.g=1,this.b=1},E=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.a=1,t}return v(t,e),t}(x);!function(e){e[e.NoColors=0]="NoColors",e[e.FaceColors=1]="FaceColors",e[e.VertexColors=2]="VertexColors"}(T||(T={})),function(e){e.LINEAR="LINEAR",e.STEP="STEP",e.CUBICSPLINE="CUBICSPLINE"}(w||(w={})),function(e){e.TRANSLATION="translation",e.ROTATION="rotation",e.SCALE="scale"}(b||(b={}));var A=function(){function e(e,t){void 0===t&&(t=""),this.keyframes=[],this.name="",this.path=e,this.name=t}return e.prototype.addKeyframe=function(e,t,n,r){console.assert(t.length>=3);var i={interpType:n,time:e,value:t};if(n===w.CUBICSPLINE){var o={};r&&(r.inTangent&&(o.inTangent=r.inTangent),r.inTangentWeight&&(o.inTangentWeight=r.inTangentWeight),r.outTangent&&(o.outTangent=r.outTangent),r.outTangentWeight&&(o.outTangentWeight=r.outTangentWeight)),Object.keys(o).length>0&&(i.extras=o)}this.keyframes.push(i)},e}(),O=function(){function e(e){void 0===e&&(e=""),this.name="",this.animations=[],this.index=-1,this._nodes=[],this.name=e}return e.prototype.addNode=function(e){this._nodes.indexOf(e)>=0||this._nodes.push(e)},e.prototype.removeNode=function(t){var n=t instanceof e?this._nodes.indexOf(t):t;return n>=0&&n<this._nodes.length&&this._nodes.splice(n,1),n},e.prototype.forEachNode=function(e){this._nodes.forEach(e)},e.prototype.addAnimation=function(e){this.animations.push(e)},e.prototype.removeAnimation=function(e){var t=e instanceof A?this.animations.indexOf(e):e;return t>=0&&t<this.animations.length&&this.animations.splice(t,1),t},e.prototype.setTranslation=function(e,t,n){this._translation=new s(e,t,n)},e.prototype.getTranslation=function(){return this._translation||new s(0,0,0)},e.prototype.setRotationDegrees=function(e,t,n){this.setRotationRadians(u(e),u(t),u(n))},e.prototype.setRotationRadians=function(e,t,n){this._rotation=function(e,t,n){var r=Math.cos(.5*n),i=Math.sin(.5*n),o=Math.cos(.5*e),s=Math.sin(.5*e),u=Math.cos(.5*t),f=Math.sin(.5*t);return new a(r*s*u-i*o*f,r*o*f+i*s*u,i*o*u-r*s*f,r*o*u+i*s*f)}(e,t,n)},e.prototype.setRotationQuaternion=function(e,t,n,r){this._rotation=new a(e,t,n,r)},e.prototype.getRotationQuaternion=function(){return this._rotation||new a(0,0,0,1)},e.prototype.setScale=function(e,t,n){this._scale=new s(e,t,n)},e.prototype.getScale=function(){return this._scale||new s(1,1,1)},e}(),I=function(){function e(e){void 0===e&&(e=""),this.name="",this._nodes=[],this.name=e}return e.prototype.addNode=function(e){this._nodes.indexOf(e)>=0||this._nodes.push(e)},e.prototype.removeNode=function(e){var t=e instanceof O?this._nodes.indexOf(e):e;return t>=0&&t<this._nodes.length&&this._nodes.splice(t,1),t},e.prototype.forEachNode=function(e){this._nodes.forEach(e)},e}(),S=function(){function e(){this.material=[],this.mode=p.TRIANGLES,this._vertices=[],this._faceColors=[],this._materialIndices=[]}return e.prototype.addFace=function(e,t,n,r,i){this._vertices.push(e),this._vertices.push(t),this._vertices.push(n),this._faceColors.push(r),void 0===i&&(i=-1),this._materialIndices.push(i)},e.prototype.forEachFace=function(e){for(var t=0;t<this._vertices.length/3;t++)e(this._vertices[3*t],this._vertices[3*t+1],this._vertices[3*t+2],this._faceColors[t],this._materialIndices[t])},e}(),C=function(){this.name="",this.alphaCutoff=.5,this.alphaMode=m.OPAQUE,this.doubleSided=!1,this.vertexColorMode=T.NoColors,this.pbrMetallicRoughness={metallicFactor:1,roughnessFactor:1}},N=function(){function e(e){this.wrapS=d.CLAMP_TO_EDGE,this.wrapT=d.CLAMP_TO_EDGE,this.image=e}return Object.defineProperty(e.prototype,"image",{get:function(){return this.__image},set:function(e){if(!e)throw new Error("Why is the texture image being unset?");this.__image=e},enumerable:!0,configurable:!0}),e}(),M=function(){this.x=0,this.y=0,this.z=0,this.u=0,this.v=0,this.normalX=0,this.normalY=0,this.normalZ=0},R=function(e,t){void 0===e&&(e=null),void 0===t&&(t=""),this.name="",this.skeletonNode=e,this.name=t};function L(e){var t=new i,n=new I;return n.name=e.name,t.addScene(n),n.addNode(function e(t){var n=new O;if(n.name=t.name,function(e){return"Mesh"===e.type}(t))n.mesh=function(e){var t=new S,n=e.geometry;if(!function(e){return"Geometry"===e.type}(n))throw new Error("BufferGeometry (or other type) not supported.");for(var r=0;r<n.faces.length;r++){var i=n.faces[r],o=new x;o.r=i.color.r,o.g=i.color.g,o.b=i.color.b,t.addFace(z(n,r,i.a,0),z(n,r,i.b,1),z(n,r,i.c,2),o,i.materialIndex)}t.material=function(e){var t=[];Array.isArray(e)||(e=[e]);for(var n=0,r=e;n<r.length;n++){var i=r[n];t.push(B(i))}return t}(e.material);return t}(t);else{n.setTranslation(t.position.x,t.position.y,t.position.z),n.setRotationRadians(t.rotation.x,t.rotation.y,t.rotation.z),n.setScale(t.scale.x,t.scale.y,t.scale.z);for(var r=0,i=t.children;r<i.length;r++){var o=i[r];n.addNode(e(o))}}return n}(e)),t}function B(e){var t=new C;if(t.doubleSided=2===e.side,"MeshBasicMaterial"!==e.type)throw new Error(e.type+" is currently not supported.");if(t.pbrMetallicRoughness.metallicFactor=0,t.pbrMetallicRoughness.roughnessFactor=0,e.transparent&&(t.alphaMode=m.MASK,t.alphaCutoff=e.alphaTest),t.vertexColorMode=e.vertexColors,e.color&&!1===e.vertexColors&&(t.pbrMetallicRoughness.baseColorFactor=[e.color.r,e.color.g,e.color.b,1]),e.map){var n=new N(e.map.image);n.wrapS=P(e.map.wrapS),n.wrapT=P(e.map.wrapT),t.pbrMetallicRoughness.baseColorTexture=n}return t}function z(e,t,n,r){var i=new M,o=e.vertices[n];i.x=o.x,i.y=o.y,i.z=o.z,e.faceVertexUvs[0]&&e.faceVertexUvs[0][t]&&e.faceVertexUvs[0][t][r]&&(i.u=e.faceVertexUvs[0][t][r].x,i.v=e.faceVertexUvs[0][t][r].y);var s=e.faces[t];return s.vertexNormals[r]&&(i.normalX=s.vertexNormals[r].x,i.normalY=s.vertexNormals[r].y,i.normalZ=s.vertexNormals[r].z),s.vertexColors[r]&&(i.color=new x,i.color.r=s.vertexColors[r].r,i.color.g=s.vertexColors[r].g,i.color.b=s.vertexColors[r].b),i}function P(e){switch(e){case 1e3:return d.REPEAT;case 1002:return d.MIRRORED_REPEAT;case 1001:default:return d.CLAMP_TO_EDGE}}var V=function(){function e(e){this._bufferViews=[],this._finalized=!1,this._gltf=e,e.buffers||(e.buffers=[]),this._index=e.buffers.length;var t={byteLength:-1};e.buffers.push(t),this._gltfBuffer=t}return e.prototype.getIndex=function(){return this._index},e.prototype.addBufferView=function(e,t){if(this._finalizePromise)throw new Error("Cannot add buffer view after finalizing buffer");var n=new G(this,this._gltf,e,t);return this._bufferViews.push(n),n},e.prototype.getByteOffset=function(e){for(var t=0,n=0,r=this._bufferViews;n<r.length;n++){var i=r[n];if(i===e)return t;t+=i.getSize()}throw"Given bufferView was not present in this buffer"},e.prototype.getViewFinalizePromises=function(e){for(var t=[],n=0,r=this._bufferViews;n<r.length;n++){var i=r[n];if(e&&i===e)return t;t.push(i.finalized)}return t},e.prototype.getArrayBuffer=function(){if(!this._finalized)throw new Error("Cannot get ArrayBuffer from Buffer before it is finalized");for(var e=this._getTotalSize(),t=new ArrayBuffer(e),n=0,r=0,i=this._bufferViews;r<i.length;r++){var o=i[r];o.writeOutToBuffer(t,n),n+=o.getSize()}return t},e.prototype.finalize=function(){var e=this;if(this._finalizePromise)throw new Error("Buffer "+this._index+" was already finalized");return this._finalizePromise=new Promise((function(t){t(Promise.all(e.getViewFinalizePromises()))})).then((function(){e._finalized=!0;var t=e.getArrayBuffer();e._gltfBuffer.byteLength=t.byteLength,e._gltfBuffer.uri=t})),this._gltf.extras.promises.push(this._finalizePromise),this._finalizePromise},e.prototype._getTotalSize=function(){for(var e=0,t=0,n=this._bufferViews;t<n.length;t++){e+=n[t].getSize()}return e},e}(),G=function(){function e(e,t,n,r){this._data=[],this._finalized=!1,this._accessorIndex=-1,this._accessorAttr=null,this._accessorMin=null,this._accessorMax=null,this._buffer=e,this._componentType=n,this._dataType=r,t.bufferViews||(t.bufferViews=[]),this._index=t.bufferViews.length,this._gltfBufferView={buffer:e.getIndex(),byteLength:-1};var i=this._getElementSize();i>=4&&(this._gltfBufferView.byteStride=i),t.bufferViews.push(this._gltfBufferView)}return e.prototype.getBuffer=function(){return this._buffer},e.prototype.getIndex=function(){return this._index},e.prototype.push=function(e){var t=this._data.length;if(this._data.push(e),this._accessorIndex>=0){var n=t%this._numComponentsForDataType(),r=this._accessorMin[n];this._accessorMin[n]="number"!=typeof r?e:Math.min(r,e);var i=this._accessorMax[n];this._accessorMax[n]="number"!=typeof i?e:Math.max(i,e)}},e.prototype.getDataSize=function(){return this._data.length*this._sizeOfComponentType()},e.prototype.getSize=function(){return e=this.getDataSize(),(t=4)*Math.ceil(e/t);var e,t},e.prototype.getByteOffset=function(){if(!this._finalized)throw new Error("Cannot get BufferView offset until it is finalized");return this._buffer.getByteOffset(this)},e.prototype.writeOutToBuffer=function(e,t){void 0===t&&(t=this.getSize());for(var n=new DataView(e,t),r=this._sizeOfComponentType(),i=0;i<this._data.length;i++){var o=this._data[i];this._writeValue(n,i*r,o)}},e.prototype.writeAsync=function(e,t){var n=this;if(void 0===t&&(t=this.getSize()),this._asyncWritePromise)throw new Error("Can't write multiple buffer view values asynchronously");return this._asyncWritePromise=e.then((function(e){for(var t=new Uint8Array(e),r=0;r<t.byteLength;r++)n._data.push(t[r]);delete n._asyncWritePromise})),this._asyncWritePromise},e.prototype.startAccessor=function(e){if(void 0===e&&(e=null),this._accessorIndex>=0)throw"Accessor was started without ending the previous one";this._accessorIndex=this._data.length,this._accessorAttr=e,this._accessorMin=new Array(this._numComponentsForDataType()),this._accessorMax=new Array(this._numComponentsForDataType())},e.prototype.endAccessor=function(){if(this._accessorIndex<0)throw"An accessor was not started, but was attempted to be ended";var e=this._getElementSize(),t=this._numComponentsForDataType(),n=(this._data.length-this._accessorIndex)/t;if(n%1)throw"An accessor was ended with missing component values";for(var r=0;r<this._accessorMin.length;r++)"number"!=typeof this._accessorMin[r]&&(this._accessorMin[r]=0),"number"!=typeof this._accessorMax[r]&&(this._accessorMax[r]=0);var i={byteOffset:e*(this._accessorIndex/t),componentType:this._componentType,count:n,type:this._dataType,min:this._accessorMin,max:this._accessorMax};switch(this._accessorAttr){case"TEXCOORD_0":case"TEXCOORD_1":case"COLOR_0":switch(this._componentType){case h.UNSIGNED_BYTE:case h.UNSIGNED_SHORT:i.normalized=!0}}return this._accessorIndex=-1,this._accessorAttr=null,this._accessorMin=null,this._accessorMax=null,i},Object.defineProperty(e.prototype,"finalized",{get:function(){var e=this;return this._finalizedPromise?this._finalizedPromise:this._finalized?this._finalizedPromise=Promise.resolve():this._finalizedPromise=new Promise((function(t){e._finalizedPromiseResolve=t}))},enumerable:!0,configurable:!0}),e.prototype.finalize=function(){var e=this,t=this._gltfBufferView;return new Promise((function(t){var n=e._buffer.getViewFinalizePromises(e);e._asyncWritePromise&&n.push(e._asyncWritePromise),t(Promise.all(n))})).then((function(){e._finalized=!0,t.byteOffset=e.getByteOffset(),t.byteLength=e.getDataSize(),e._finalizedPromiseResolve&&e._finalizedPromiseResolve()}))},e.prototype._getElementSize=function(){return this._sizeOfComponentType()*this._numComponentsForDataType()},e.prototype._sizeOfComponentType=function(){switch(this._componentType){case h.BYTE:case h.UNSIGNED_BYTE:return 1;case h.SHORT:case h.UNSIGNED_SHORT:return 2;case h.UNSIGNED_INT:case h.FLOAT:return 4}throw"Unrecognized component type "+this._componentType},e.prototype._numComponentsForDataType=function(){switch(this._dataType){case l.SCALAR:return 1;case l.VEC2:return 2;case l.VEC3:return 3;case l.VEC4:case l.MAT2:return 4;case l.MAT3:return 9;case l.MAT4:return 16}throw"Unsupported data type"},e.prototype._writeValue=function(e,t,n){switch(this._componentType){case h.BYTE:e.setInt8(t,n);break;case h.UNSIGNED_BYTE:e.setUint8(t,n);break;case h.SHORT:e.setInt16(t,n,!0);break;case h.UNSIGNED_SHORT:e.setUint16(t,n,!0);break;case h.UNSIGNED_INT:e.setUint32(t,n,!0);break;case h.FLOAT:e.setFloat32(t,n,!0);break;default:throw"Unsupported data type"}},e}();function U(e){var t,n,r=D(e),i=new Promise((function(e,r){t=e,n=r}));return r.toBlob((function(e){if(e){var r=new FileReader;r.addEventListener("loadend",(function(){t(r.result)})),r.readAsArrayBuffer(e)}else n("Unable to convert image to PNG")}),"image/png"),i}function D(e){var t;e instanceof HTMLImageElement?((t=document.createElement("canvas")).width=e.width,t.height=e.height,t.getContext("2d").drawImage(e,0,0,e.width,e.height)):t=e;return t}function F(e,t){e.scene=t.defaultScene;var n=e.extras.options.bufferOutputType===f.GLB||e.extras.options.imageOutputType===c.GLB;n&&(e.extras.binChunkBuffer=Y(e)),t.forEachScene((function(e){!function e(t){t instanceof O&&(t.index=-1);t.forEachNode((function(t){e(t)}))}(e)})),t.forEachScene((function(t){!function(e,t){e.scenes||(e.scenes=[]);var n={};t.name&&(n.name=t.name);t.forEachNode((function(t){n.nodes||(n.nodes=[]);var r=k(e,t);n.nodes.push(r)})),e.scenes.push(n)}(e,t)})),n&&e.extras.binChunkBuffer.finalize()}function k(e,t){if(t.index>=0)return t.index;e.nodes||(e.nodes=[]);var n={};t.name&&(n.name=t.name);var r=t.getTranslation();0===r.x&&0===r.y&&0===r.z||(n.translation=r.toArray());var i=t.getRotationQuaternion();0===i.x&&0===i.y&&0===i.z&&1===i.w||(n.rotation=i.toArray());var o=t.getScale();1===o.x&&1===o.y&&1===o.z||(n.scale=o.toArray());var s=e.nodes.length;return t.index=s,e.nodes.push(n),t.animations&&t.animations.length>0&&function(e,t,n){if(0===t.length)return;var r,i=e.extras.options.bufferOutputType===f.GLB;r=i?e.extras.binChunkBuffer:Y(e);var o,s,a=r.addBufferView(h.FLOAT,l.SCALAR);if(!e.animations||0==e.animations.length){e.animations=[{channels:[],samplers:[]}]}var u=e.animations[0];t[0].name&&!u.name&&(u.name=t[0].name);function c(t,r,i){var o=a.endAccessor(),s=W(e,a.getIndex(),o),f=t.endAccessor(),c={input:s,output:W(e,t.getIndex(),f),interpolation:r},h={sampler:u.samplers.length,target:{node:n,path:i}};u.samplers.push(c),u.channels.push(h)}for(var p=0,d=t;p<d.length;p++){var m=d[p];if(m.keyframes&&0!=m.keyframes.length){var y=m.path,g=4==m.keyframes[0].value.length,_=void 0;g?(o||(o=r.addBufferView(h.FLOAT,l.VEC4)),_=o):(s||(s=r.addBufferView(h.FLOAT,l.VEC3)),_=s),a.startAccessor(),_.startAccessor();for(var v=m.keyframes[0].interpType,T=0,b=m.keyframes.length,x=0;x<b;++x){var E=m.keyframes[x],A=E.interpType;A!=v&&(c(_,v,y),a.startAccessor(),_.startAccessor(),T=0);var O=A===w.CUBICSPLINE;if(O&&g)throw new Error("CUBICSPLINE for Vector4 not implemented!");var I=E.time,S=E.value;if(a.push(I),O){var C=E.extras,N=[0,0,0],M=[0,0,0];(null==C?void 0:C.inTangent)&&T>0&&(M=C.inTangent),(null==C?void 0:C.outTangent)&&x<b-1&&m.keyframes[x+1].interpType===w.CUBICSPLINE&&(N=C.outTangent);for(var R=0,L=[M,S,N];R<L.length;R++)for(var B=L[R],z=0;z<3;++z)_.push(B[z])}else{var P=g?4:3;for(z=0;z<P;++z)_.push(S[z])}++T,v=A}c(_,v,y)}}a.finalize(),o&&o.finalize();s&&s.finalize();i||r.finalize()}(e,t.animations,s),t.mesh&&(n.mesh=function(e,t){e.meshes||(e.meshes=[]);if(t.mode!==p.TRIANGLES)throw"MeshMode other than TRIANGLES not currently supported";!function(e,t){for(var n=[],r=0,i=t;r<i.length;r++){var o=i[r];n.push(H(e,o))}}(e,t.material);var n={primitives:[]},r=e.meshes.length;e.meshes.push(n);var i,o=e.extras.options.bufferOutputType===f.GLB;i=o?e.extras.binChunkBuffer:Y(e);var s,a=i.addBufferView(h.FLOAT,l.VEC3),u=i.addBufferView(h.FLOAT,l.VEC3),c=i.addBufferView(h.FLOAT,l.VEC2);function d(n){var r=a.endAccessor(),i=u.endAccessor(),o=c.endAccessor(),f={attributes:{POSITION:W(e,a.getIndex(),r),NORMAL:W(e,u.getIndex(),i),TEXCOORD_0:W(e,c.getIndex(),o)},mode:t.mode};if(n>=0&&(f.material=n,t.material[n].vertexColorMode!==T.NoColors)){var h=s.endAccessor();f.attributes.COLOR_0=W(e,s.getIndex(),h)}return f}var m=null;if(t.forEachFace((function(e,r,o,f,p){var y=null;if(p>=0&&(y=t.material[p]),m!==p){if(null!==m){var g=d(m);n.primitives.push(g)}a.startAccessor("POSITION"),u.startAccessor("NORMAL"),c.startAccessor("TEXCOORD_0"),y&&y.vertexColorMode!==T.NoColors&&(!function(){if(s)return;s=i.addBufferView(h.UNSIGNED_BYTE,l.VEC4)}(),s.startAccessor("COLOR_0")),m=p}if(a.push(e.x),a.push(e.y),a.push(e.z),a.push(r.x),a.push(r.y),a.push(r.z),a.push(o.x),a.push(o.y),a.push(o.z),u.push(e.normalX),u.push(e.normalY),u.push(e.normalZ),u.push(r.normalX),u.push(r.normalY),u.push(r.normalZ),u.push(o.normalX),u.push(o.normalY),u.push(o.normalZ),c.push(e.u),c.push(e.v),c.push(r.u),c.push(r.v),c.push(o.u),c.push(o.v),y)switch(y.vertexColorMode){case T.FaceColors:for(var _=0;_<3;_++)j(s,f||new x);break;case T.VertexColors:j(s,e.color||new x),j(s,r.color||new x),j(s,o.color||new x)}})),null!==m){var y=d(m);n.primitives.push(y)}a.finalize(),u.finalize(),c.finalize(),s&&s.finalize();o||i.finalize();return r}(e,t.mesh)),t.forEachNode((function(t){n.children||(n.children=[]);var r=k(e,t);n.children.push(r)})),t.skin&&(n.skin=function(e,t,n){e.skins||(e.skins=[]);var r=e.skins.length,i={joints:[]};e.skins.push(i),t.name.length>0&&(i.name=t.name);var o=n.skin.skeletonNode;o&&(o.index<0&&k(e,o),i.skeleton=o.index);var s=function e(t){if(t.index<0)throw new Error("Node should be added to gltf before running this function");var n=[t.index],r=[t.inverseBindMatrix];return t.forEachNode((function(t){var i=e(t);n=n.concat(i[0]),r=r.concat(i[1])})),[n,r]}(o||n);i.joints=s[0];for(var a=s[1],u=!1,c=0,p=a;c<p.length;c++){if((w=p[c])&&4===w.rows&&4===w.cols&&!_.IsIdentity(w)){u=!0;break}}if(!u)return r;var d=e.extras.options.bufferOutputType===f.GLB,m=d?e.extras.binChunkBuffer:Y(e),y=m.addBufferView(h.FLOAT,l.MAT4);y.startAccessor();for(var g=0,v=a;g<v.length;g++)for(var T=v[g],w=T instanceof _?T:new _,b=0;b<4;b++)for(var x=0;x<4;x++)y.push(w.data[x][b]);var E=y.endAccessor(),A=W(e,y.getIndex(),E);i.inverseBindMatrices=A,y.finalize(),d||m.finalize();return r}(e,t.skin,t)),s}function j(e,t){e.push(255*t.r|0),e.push(255*t.g|0),e.push(255*t.b|0),"a"in t?e.push(255*t.a|0):e.push(255)}function Y(e){return new V(e)}function W(e,t,n){e.accessors||(e.accessors=[]);var r=e.accessors.length,i=n.componentType,o={bufferView:t,byteOffset:n.byteOffset,componentType:i,count:n.count,type:n.type,min:n.min,max:n.max};return n.normalized&&(o.normalized=!0),e.accessors.push(o),r}function H(e,t){e.materials||(e.materials=[]);var n={};if(t.name&&(n.name=t.name),t.alphaMode!==m.OPAQUE&&(n.alphaMode=t.alphaMode),.5!==t.alphaCutoff&&(n.alphaCutoff=t.alphaCutoff),t.doubleSided&&(n.doubleSided=!0),t.pbrMetallicRoughness&&(t.pbrMetallicRoughness.baseColorFactor&&(n.pbrMetallicRoughness={},n.pbrMetallicRoughness.baseColorFactor=t.pbrMetallicRoughness.baseColorFactor),t.pbrMetallicRoughness.baseColorTexture)){n.pbrMetallicRoughness||(n.pbrMetallicRoughness={});var r=function(e,t){e.textures||(e.textures=[]);var n={sampler:Q(e,t),source:X(e,t.image)},r=e.textures.length;return e.textures.push(n),r}(e,t.pbrMetallicRoughness.baseColorTexture);n.pbrMetallicRoughness.baseColorTexture={index:r}}var i=e.materials.length;return e.materials.push(n),i}function X(e,t){e.images||(e.images=[]);for(var n=0;n<e.images.length;n++)if(t===e.images[n].extras)return n;var r={extras:t};switch(e.extras.options.imageOutputType){case c.GLB:var i=e.extras.binChunkBuffer.addBufferView(h.UNSIGNED_BYTE,l.SCALAR);i.writeAsync(U(t)).then((function(){i.finalize()})),r.bufferView=i.getIndex(),r.mimeType="image/png";break;case c.DataURI:r.uri=function(e){return D(e).toDataURL()}(t);break;default:e.extras.promises.push(U(t).then((function(e){r.uri=e})))}var o=e.images.length;return e.images.push(r),o}function Q(e,t){e.samplers||(e.samplers=[]);for(var n,r,i={wrapS:t.wrapS,wrapT:t.wrapT},o=0;o<e.samplers.length;o++)if(n=i,r=e.samplers[o],JSON.stringify(n)===JSON.stringify(r))return o;var s=e.samplers.length;return e.samplers.push(i),s}var J;function Z(e,t){if(!e)throw new Error("GLB requires a JSON glTF chunk");var n=12;n+=8;var r=function(e){return(new TextEncoder).encode(e).buffer}(e);if(n+=q(r.byteLength,4),t&&(n+=8,n+=t.byteLength,t.byteLength%4))throw new Error("Expected BIN chunk length to be divisible by 4 at this point");var i=new ArrayBuffer(n),o=new DataView(i);!function(e,t){e.setUint32(0,1179937895,!0),e.setUint32(4,2,!0),e.setUint32(8,t,!0)}(o,n);var s=K(o,r,12,J.JSON,32);return t&&K(o,t,s,J.BIN),i}function K(e,t,n,r,i){void 0===i&&(i=0);var o,s,a,u,f,c=q(t.byteLength,4);for(e.setUint32(n,c,!0),e.setUint32(n+=4,r,!0),o=e.buffer,s=t,a=n+=4,u=0,f=t.byteLength,new Uint8Array(o,a,f).set(new Uint8Array(s,u,f),0),n+=t.byteLength;n%4;)i&&e.setUint8(n,i),n++;return n}function q(e,t){return t*Math.ceil(e/t)}!function(e){e[e.JSON=1313821514]="JSON",e[e.BIN=5130562]="BIN"}(J||(J={}));function $(e,t){t=t||{};var n={asset:{version:"2.0",copyright:e.copyright,generator:e.generator},extras:{options:t,binChunkBuffer:null,promises:[]}};F(n,e);var r=n.extras.promises,i=1,o=1,s=null;return Promise.all(r).then((function(){var e={};delete n.extras;var r="number"==typeof t.jsonSpacing?t.jsonSpacing:4,a=JSON.stringify(n,(function(n,r){if("extras"!==n){if(r instanceof ArrayBuffer){if(function(e){if(e.byteLength<8)return!1;var t=new Uint8Array(e);return 137===t[0]&&80===t[1]&&78===t[2]&&71===t[3]&&13===t[4]&&10===t[5]&&26===t[6]&&10===t[7]}(r))switch(t.imageOutputType){case c.DataURI:case c.GLB:break;default:var a="img"+o+".png";return o++,e[a]=r,a}switch(t.bufferOutputType){case f.DataURI:return function(e){for(var t=[],n=new Uint8Array(e),r=0;r<n.length;r++)t.push(String.fromCharCode(n[r]));return"data:application/octet-stream;base64,"+btoa(t.join(""))}(r);case f.GLB:if(s)throw new Error("Already encountered an ArrayBuffer, there should only be one in the GLB format.");return void(s=r);default:a="data"+i+".bin";return i++,e[a]=r,a}}return r}}),r);return t.bufferOutputType===f.GLB||t.imageOutputType===c.GLB?e["model.glb"]=Z(a,s):e["model.gltf"]=a,e}))}function ee(e,t,n){return $(e,n).then((function(e){var n=new t;for(var r in e)n.file(r,e[r]);return n.generateAsync({type:"blob"})}))}function te(e){return $(e,{bufferOutputType:f.GLB,imageOutputType:c.GLB,jsonSpacing:0}).then((function(e){return e["model.glb"]}))}}])}));