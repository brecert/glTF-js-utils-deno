!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.GLTFUtils=t():e.GLTFUtils=t()}("undefined"!=typeof self?self:this,(function(){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(r,o,function(t){return e[t]}.bind(null,o));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t,n){"use strict";n.r(t),n.d(t,"GLTFAsset",(function(){return o})),n.d(t,"Scene",(function(){return O})),n.d(t,"Node",(function(){return I})),n.d(t,"Mesh",(function(){return S})),n.d(t,"Material",(function(){return C})),n.d(t,"Texture",(function(){return N})),n.d(t,"Vertex",(function(){return M})),n.d(t,"Skin",(function(){return B})),n.d(t,"Animation",(function(){return A})),n.d(t,"Vector3",(function(){return s})),n.d(t,"Quaternion",(function(){return a})),n.d(t,"Matrix",(function(){return m})),n.d(t,"Matrix3x3",(function(){return g})),n.d(t,"Matrix4x4",(function(){return v})),n.d(t,"glTFAssetFromTHREE",(function(){return L})),n.d(t,"AlphaMode",(function(){return y})),n.d(t,"ComponentType",(function(){return h})),n.d(t,"DataType",(function(){return l})),n.d(t,"MeshMode",(function(){return p})),n.d(t,"RGBColor",(function(){return x})),n.d(t,"RGBAColor",(function(){return E})),n.d(t,"VertexColorMode",(function(){return w})),n.d(t,"WrappingMode",(function(){return d})),n.d(t,"InterpolationMode",(function(){return b})),n.d(t,"Transformation",(function(){return T})),n.d(t,"ImageOutputType",(function(){return c})),n.d(t,"BufferOutputType",(function(){return f})),n.d(t,"Buffer",(function(){return V})),n.d(t,"BufferView",(function(){return G})),n.d(t,"exportGLTF",(function(){return ne})),n.d(t,"exportGLTFZip",(function(){return re})),n.d(t,"exportGLB",(function(){return oe}));var r,o=function(){function e(){this.copyright="",this.defaultScene=0,this.generator="glTF-js-utils",this._scenes=[]}return e.prototype.setDefaultScene=function(e){if("number"==typeof e)this.defaultScene=e;else{var t=this._scenes.indexOf(e);if(-1===t)throw new Error("Scene passed to setDefaultScene was not found.");this.defaultScene=t}},e.prototype.addScene=function(e){if(this._scenes.indexOf(e)>=0)throw new Error("Scene passed to addScene was added prior.");this._scenes.push(e)},e.prototype.removeScene=function(e){var t=this._scenes.indexOf(e);t>=0&&this._scenes.splice(t,1)},e.prototype.forEachScene=function(e){this._scenes.forEach(e)},e}(),i=(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)},function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),s=function(){function e(e,t,n){this.x=0,this.y=0,this.z=0,this.x=e,this.y=t,this.z=n}return e.prototype.toArray=function(){return[this.x,this.y,this.z]},e}(),a=function(){function e(e,t,n,r){this.x=e,this.y=t,this.z=n,this.w=r}return e.prototype.toArray=function(){return[this.x,this.y,this.z,this.w]},e}();function u(e){return e*Math.PI/180}var f,c,h,l,p,d,y,m=function(){function e(t){void 0===t&&(t=4),this.data=e.Identity(t)}return Object.defineProperty(e.prototype,"m",{get:function(){return this.data},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"rows",{get:function(){return this.data.length},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"cols",{get:function(){return 0===this.rows?0:this.data[0].length},enumerable:!1,configurable:!0}),e.Identity=function(e){for(var t=[],n=0;n<e;++n){for(var r=[],o=0;o<e;++o)r.push(n===o?1:0);t.push(r)}return t},e.IsIdentity=function(e){var t=e.rows,n=e.cols;if(t!==n)return!1;for(var r=0;r<t;++r)for(var o=0;o<n;++o)if(e.data[r][o]!=(r===o?1:0))return!1;return!0},e}(),g=function(e){function t(){return e.call(this,3)||this}return i(t,e),t.Identity=function(){return m.Identity(3)},t.IsIdentity=function(e){return 3===e.rows&&3===e.cols&&m.IsIdentity(e)},t}(m),v=function(e){function t(){return e.call(this,4)||this}return i(t,e),t.Identity=function(){return m.Identity(4)},t.IsIdentity=function(e){return 4===e.rows&&4===e.cols&&m.IsIdentity(e)},t}(m),_=function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();!function(e){e[e.External=0]="External",e[e.DataURI=1]="DataURI",e[e.GLB=2]="GLB"}(f||(f={})),function(e){e[e.External=0]="External",e[e.DataURI=1]="DataURI",e[e.GLB=2]="GLB"}(c||(c={})),function(e){e[e.BYTE=5120]="BYTE",e[e.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",e[e.SHORT=5122]="SHORT",e[e.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",e[e.UNSIGNED_INT=5125]="UNSIGNED_INT",e[e.FLOAT=5126]="FLOAT"}(h||(h={})),function(e){e.SCALAR="SCALAR",e.VEC2="VEC2",e.VEC3="VEC3",e.VEC4="VEC4",e.MAT2="MAT2",e.MAT3="MAT3",e.MAT4="MAT4"}(l||(l={})),function(e){e[e.POINTS=0]="POINTS",e[e.LINES=1]="LINES",e[e.LINE_LOOP=2]="LINE_LOOP",e[e.LINE_STRIP=3]="LINE_STRIP",e[e.TRIANGLES=4]="TRIANGLES",e[e.TRIANGLE_STRIP=5]="TRIANGLE_STRIP",e[e.TRIANGLE_FAN=6]="TRIANGLE_FAN"}(p||(p={})),function(e){e[e.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",e[e.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",e[e.REPEAT=10497]="REPEAT"}(d||(d={})),function(e){e.OPAQUE="OPAQUE",e.MASK="MASK",e.BLEND="BLEND"}(y||(y={}));var w,b,T,x=function(){this.r=1,this.g=1,this.b=1},E=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.a=1,t}return _(t,e),t}(x);!function(e){e[e.NoColors=0]="NoColors",e[e.FaceColors=1]="FaceColors",e[e.VertexColors=2]="VertexColors"}(w||(w={})),function(e){e.LINEAR="LINEAR",e.STEP="STEP",e.CUBICSPLINE="CUBICSPLINE"}(b||(b={})),function(e){e.TRANSLATION="translation",e.ROTATION="rotation",e.SCALE="scale"}(T||(T={}));var A=function(){function e(e,t){void 0===t&&(t=""),this.keyframes=[],this.name="",this.path=e,this.name=t}return e.prototype.addKeyframe=function(e,t,n,r){console.assert(t.length>=3);var o={interpType:n,time:e,value:t};if(n===b.CUBICSPLINE){var i={};r&&(r.inTangent&&(i.inTangent=r.inTangent),r.inTangentWeight&&(i.inTangentWeight=r.inTangentWeight),r.outTangent&&(i.outTangent=r.outTangent),r.outTangentWeight&&(i.outTangentWeight=r.outTangentWeight)),Object.keys(i).length>0&&(o.extras=i)}this.keyframes.push(o)},e}(),I=function(){function e(e){void 0===e&&(e=""),this.name="",this.animations=[],this._nodes=[],this.name=e}return e.prototype.addNode=function(e){this._nodes.indexOf(e)>=0||this._nodes.push(e)},e.prototype.removeNode=function(t){var n=t instanceof e?this._nodes.indexOf(t):t;return n>=0&&n<this._nodes.length&&this._nodes.splice(n,1),n},e.prototype.forEachNode=function(e){this._nodes.forEach(e)},e.prototype.addAnimation=function(e){this.animations.push(e)},e.prototype.removeAnimation=function(e){var t=e instanceof A?this.animations.indexOf(e):e;return t>=0&&t<this.animations.length&&this.animations.splice(t,1),t},e.prototype.setTranslation=function(e,t,n){this._translation=new s(e,t,n)},e.prototype.getTranslation=function(){return this._translation||new s(0,0,0)},e.prototype.setRotationDegrees=function(e,t,n){this.setRotationRadians(u(e),u(t),u(n))},e.prototype.setRotationRadians=function(e,t,n){this._rotation=function(e,t,n){var r=Math.cos(.5*n),o=Math.sin(.5*n),i=Math.cos(.5*e),s=Math.sin(.5*e),u=Math.cos(.5*t),f=Math.sin(.5*t);return new a(r*s*u-o*i*f,r*i*f+o*s*u,o*i*u-r*s*f,r*i*u+o*s*f)}(e,t,n)},e.prototype.setRotationQuaternion=function(e,t,n,r){this._rotation=new a(e,t,n,r)},e.prototype.getRotationQuaternion=function(){return this._rotation||new a(0,0,0,1)},e.prototype.setScale=function(e,t,n){this._scale=new s(e,t,n)},e.prototype.getScale=function(){return this._scale||new s(1,1,1)},e}(),O=function(){function e(e){void 0===e&&(e=""),this.name="",this._nodes=[],this.name=e}return e.prototype.addNode=function(e){this._nodes.indexOf(e)>=0||this._nodes.push(e)},e.prototype.removeNode=function(e){var t=e instanceof I?this._nodes.indexOf(e):e;return t>=0&&t<this._nodes.length&&this._nodes.splice(t,1),t},e.prototype.forEachNode=function(e){this._nodes.forEach(e)},e}(),S=function(){function e(){this.material=[],this.mode=p.TRIANGLES,this._vertices=[],this._faceColors=[],this._materialIndices=[]}return e.prototype.addFace=function(e,t,n,r,o){this._vertices.push(e),this._vertices.push(t),this._vertices.push(n),this._faceColors.push(r),void 0===o&&(o=-1),this._materialIndices.push(o)},e.prototype.forEachFace=function(e){for(var t=0;t<this._vertices.length/3;t++)e(this._vertices[3*t],this._vertices[3*t+1],this._vertices[3*t+2],this._faceColors[t],this._materialIndices[t])},e}(),C=function(){this.name="",this.alphaCutoff=.5,this.alphaMode=y.OPAQUE,this.doubleSided=!1,this.vertexColorMode=w.NoColors,this.pbrMetallicRoughness={metallicFactor:1,roughnessFactor:1}},N=function(){function e(e){this.wrapS=d.CLAMP_TO_EDGE,this.wrapT=d.CLAMP_TO_EDGE,this.image=e}return Object.defineProperty(e.prototype,"image",{get:function(){return this.__image},set:function(e){if(!e)throw new Error("Why is the texture image being unset?");this.__image=e},enumerable:!1,configurable:!0}),e}(),M=function(){this.x=0,this.y=0,this.z=0,this.u=0,this.v=0,this.normalX=0,this.normalY=0,this.normalZ=0},B=function(e,t){void 0===e&&(e=null),void 0===t&&(t=""),this.name="",this.skeletonNode=e,this.name=t};function L(e){var t=new o,n=new O;return n.name=e.name,t.addScene(n),n.addNode(function e(t){var n=new I;if(n.name=t.name,function(e){return"Mesh"===e.type}(t))n.mesh=function(e){var t=new S,n=e.geometry;if(!function(e){return"Geometry"===e.type}(n))throw new Error("BufferGeometry (or other type) not supported.");for(var r=0;r<n.faces.length;r++){var o=n.faces[r],i=new x;i.r=o.color.r,i.g=o.color.g,i.b=o.color.b,t.addFace(z(n,r,o.a,0),z(n,r,o.b,1),z(n,r,o.c,2),i,o.materialIndex)}t.material=function(e){var t=[];Array.isArray(e)||(e=[e]);for(var n=0,r=e;n<r.length;n++){var o=r[n];t.push(R(o))}return t}(e.material);return t}(t);else{n.setTranslation(t.position.x,t.position.y,t.position.z),n.setRotationRadians(t.rotation.x,t.rotation.y,t.rotation.z),n.setScale(t.scale.x,t.scale.y,t.scale.z);for(var r=0,o=t.children;r<o.length;r++){var i=o[r];n.addNode(e(i))}}return n}(e)),t}function R(e){var t=new C;if(t.doubleSided=2===e.side,"MeshBasicMaterial"!==e.type)throw new Error(e.type+" is currently not supported.");if(t.pbrMetallicRoughness.metallicFactor=0,t.pbrMetallicRoughness.roughnessFactor=0,e.transparent&&(t.alphaMode=y.MASK,t.alphaCutoff=e.alphaTest),t.vertexColorMode=e.vertexColors?w.VertexColors:w.NoColors,e.color&&!e.vertexColors&&(t.pbrMetallicRoughness.baseColorFactor=[e.color.r,e.color.g,e.color.b,1]),e.map){var n=new N(e.map.image);n.wrapS=P(e.map.wrapS),n.wrapT=P(e.map.wrapT),t.pbrMetallicRoughness.baseColorTexture=n}return t}function z(e,t,n,r){var o=new M,i=e.vertices[n];o.x=i.x,o.y=i.y,o.z=i.z,e.faceVertexUvs[0]&&e.faceVertexUvs[0][t]&&e.faceVertexUvs[0][t][r]&&(o.u=e.faceVertexUvs[0][t][r].x,o.v=e.faceVertexUvs[0][t][r].y);var s=e.faces[t];return s.vertexNormals[r]&&(o.normalX=s.vertexNormals[r].x,o.normalY=s.vertexNormals[r].y,o.normalZ=s.vertexNormals[r].z),s.vertexColors[r]&&(o.color=new x,o.color.r=s.vertexColors[r].r,o.color.g=s.vertexColors[r].g,o.color.b=s.vertexColors[r].b),o}function P(e){switch(e){case 1e3:return d.REPEAT;case 1002:return d.MIRRORED_REPEAT;case 1001:default:return d.CLAMP_TO_EDGE}}var V=function(){function e(e){this._bufferViews=[],this._finalized=!1,this._gltf=e,e.buffers||(e.buffers=[]),this._index=e.buffers.length;var t={byteLength:-1};e.buffers.push(t),this._gltfBuffer=t}return e.prototype.getIndex=function(){return this._index},e.prototype.addBufferView=function(e,t){if(this._finalizePromise)throw new Error("Cannot add buffer view after finalizing buffer");var n=new G(this,this._gltf,e,t);return this._bufferViews.push(n),n},e.prototype.getByteOffset=function(e){for(var t=0,n=0,r=this._bufferViews;n<r.length;n++){var o=r[n];if(o===e)return t;t+=o.getSize()}throw"Given bufferView was not present in this buffer"},e.prototype.getViewFinalizePromises=function(e){for(var t=[],n=0,r=this._bufferViews;n<r.length;n++){var o=r[n];if(e&&o===e)return t;t.push(o.finalized)}return t},e.prototype.getArrayBuffer=function(){if(!this._finalized)throw new Error("Cannot get ArrayBuffer from Buffer before it is finalized");for(var e=this._getTotalSize(),t=new ArrayBuffer(e),n=0,r=0,o=this._bufferViews;r<o.length;r++){var i=o[r];i.writeOutToBuffer(t,n),n+=i.getSize()}return t},e.prototype.finalize=function(){var e=this;if(this._finalizePromise)throw new Error("Buffer "+this._index+" was already finalized");return this._finalizePromise=new Promise((function(t){t(Promise.all(e.getViewFinalizePromises()))})).then((function(){e._finalized=!0;var t=e.getArrayBuffer();e._gltfBuffer.byteLength=t.byteLength,e._gltfBuffer.uri=t})),this._gltf.extras.promises.push(this._finalizePromise),this._finalizePromise},e.prototype._getTotalSize=function(){for(var e=0,t=0,n=this._bufferViews;t<n.length;t++){e+=n[t].getSize()}return e},e}(),G=function(){function e(e,t,n,r){this._data=[],this._finalized=!1,this._accessorIndex=-1,this._accessorAttr=null,this._accessorMin=null,this._accessorMax=null,this._buffer=e,this._componentType=n,this._dataType=r,t.bufferViews||(t.bufferViews=[]),this._index=t.bufferViews.length,this._gltfBufferView={buffer:e.getIndex(),byteLength:-1};var o=this._getElementSize();o>=4&&(this._gltfBufferView.byteStride=o),t.bufferViews.push(this._gltfBufferView)}return e.prototype.getBuffer=function(){return this._buffer},e.prototype.getIndex=function(){return this._index},e.prototype.push=function(e){var t=this._data.length;if(this._data.push(e),this._accessorIndex>=0){var n=t%this._numComponentsForDataType();if(!this._accessorMin||!this._accessorMax)throw new Error("Unexpected accessor state");var r=this._accessorMin[n];this._accessorMin[n]="number"!=typeof r?e:Math.min(r,e);var o=this._accessorMax[n];this._accessorMax[n]="number"!=typeof o?e:Math.max(o,e)}},e.prototype.getDataSize=function(){return this._data.length*this._sizeOfComponentType()},e.prototype.getSize=function(){return e=this.getDataSize(),(t=4)*Math.ceil(e/t);var e,t},e.prototype.getByteOffset=function(){if(!this._finalized)throw new Error("Cannot get BufferView offset until it is finalized");return this._buffer.getByteOffset(this)},e.prototype.writeOutToBuffer=function(e,t){void 0===t&&(t=this.getSize());for(var n=new DataView(e,t),r=this._sizeOfComponentType(),o=0;o<this._data.length;o++){var i=this._data[o];this._writeValue(n,o*r,i)}},e.prototype.writeAsync=function(e){var t=this;if(this._asyncWritePromise)throw new Error("Can't write multiple buffer view values asynchronously");return this._asyncWritePromise=e.then((function(e){for(var n=new Uint8Array(e),r=0;r<n.byteLength;r++)t._data.push(n[r]);delete t._asyncWritePromise})),this._asyncWritePromise},e.prototype.startAccessor=function(e){if(void 0===e&&(e=null),this._accessorIndex>=0)throw"Accessor was started without ending the previous one";this._accessorIndex=this._data.length,this._accessorAttr=e,this._accessorMin=new Array(this._numComponentsForDataType()),this._accessorMax=new Array(this._numComponentsForDataType())},e.prototype.endAccessor=function(){if(this._accessorIndex<0)throw new Error("An accessor was not started, but was attempted to be ended");var e=this._getElementSize(),t=this._numComponentsForDataType(),n=(this._data.length-this._accessorIndex)/t;if(n%1)throw new Error("An accessor was ended with missing component values");if(!this._accessorMin||!this._accessorMax)throw new Error("Unexpected accessor state");for(var r=0;r<this._accessorMin.length;r++)"number"!=typeof this._accessorMin[r]&&(this._accessorMin[r]=0),"number"!=typeof this._accessorMax[r]&&(this._accessorMax[r]=0);var o={byteOffset:e*(this._accessorIndex/t),componentType:this._componentType,count:n,type:this._dataType,min:this._accessorMin,max:this._accessorMax};switch(this._accessorAttr){case"TEXCOORD_0":case"TEXCOORD_1":case"COLOR_0":switch(this._componentType){case h.UNSIGNED_BYTE:case h.UNSIGNED_SHORT:o.normalized=!0}}return this._accessorIndex=-1,this._accessorAttr=null,this._accessorMin=null,this._accessorMax=null,o},Object.defineProperty(e.prototype,"finalized",{get:function(){var e=this;return this._finalizedPromise?this._finalizedPromise:this._finalized?this._finalizedPromise=Promise.resolve():this._finalizedPromise=new Promise((function(t){e._finalizedPromiseResolve=t}))},enumerable:!1,configurable:!0}),e.prototype.finalize=function(){var e=this,t=this._gltfBufferView;return new Promise((function(t){var n=e._buffer.getViewFinalizePromises(e);e._asyncWritePromise&&n.push(e._asyncWritePromise),t(Promise.all(n))})).then((function(){e._finalized=!0,t.byteOffset=e.getByteOffset(),t.byteLength=e.getDataSize(),e._finalizedPromiseResolve&&e._finalizedPromiseResolve()}))},e.prototype._getElementSize=function(){return this._sizeOfComponentType()*this._numComponentsForDataType()},e.prototype._sizeOfComponentType=function(){switch(this._componentType){case h.BYTE:case h.UNSIGNED_BYTE:return 1;case h.SHORT:case h.UNSIGNED_SHORT:return 2;case h.UNSIGNED_INT:case h.FLOAT:return 4}throw"Unrecognized component type "+this._componentType},e.prototype._numComponentsForDataType=function(){switch(this._dataType){case l.SCALAR:return 1;case l.VEC2:return 2;case l.VEC3:return 3;case l.VEC4:case l.MAT2:return 4;case l.MAT3:return 9;case l.MAT4:return 16}throw"Unsupported data type"},e.prototype._writeValue=function(e,t,n){switch(this._componentType){case h.BYTE:e.setInt8(t,n);break;case h.UNSIGNED_BYTE:e.setUint8(t,n);break;case h.SHORT:e.setInt16(t,n,!0);break;case h.UNSIGNED_SHORT:e.setUint16(t,n,!0);break;case h.UNSIGNED_INT:e.setUint32(t,n,!0);break;case h.FLOAT:e.setFloat32(t,n,!0);break;default:throw"Unsupported data type"}},e}();function U(e){var t,n,r=D(e),o=new Promise((function(e,r){t=e,n=r}));return r.toBlob((function(e){if(e){var r=new FileReader;r.addEventListener("loadend",(function(){t(r.result)})),r.readAsArrayBuffer(e)}else n("Unable to convert image to PNG")}),"image/png"),o}function D(e){var t;e instanceof HTMLImageElement?((t=document.createElement("canvas")).width=e.width,t.height=e.height,t.getContext("2d").drawImage(e,0,0,e.width,e.height)):t=e;return t}function F(e,t){e.scene=t.defaultScene;var n=e.extras.options.bufferOutputType===f.GLB||e.extras.options.imageOutputType===c.GLB;n&&(e.extras.binChunkBuffer=Y(e)),t.forEachScene((function(t){!function(e,t){e.scenes||(e.scenes=[]);var n={};t.name&&(n.name=t.name);t.forEachNode((function(t){n.nodes||(n.nodes=[]);var r=k(e,t);n.nodes.push(r)})),e.scenes.push(n)}(e,t)})),n&&e.extras.binChunkBuffer.finalize()}function k(e,t){var n=Q(e,t);if(n>=0)return n;e.nodes||(e.nodes=[]);var r={};t.name&&(r.name=t.name);var o=t.getTranslation();0===o.x&&0===o.y&&0===o.z||(r.translation=o.toArray());var i=t.getRotationQuaternion();0===i.x&&0===i.y&&0===i.z&&1===i.w||(r.rotation=i.toArray());var s=t.getScale();1===s.x&&1===s.y&&1===s.z||(r.scale=s.toArray());var a=e.nodes.length;return function(e,t,n){e.extras.nodeIndices.set(t,n)}(e,t,a),e.nodes.push(r),t.animations.length>0&&function(e,t,n){if(0===t.length)return;var r,o,i=e.extras.options.bufferOutputType===f.GLB,s=i?e.extras.binChunkBuffer:Y(e),a=s.addBufferView(h.FLOAT,l.SCALAR);if(!e.animations||0===e.animations.length){e.animations=[{channels:[],samplers:[]}]}var u=e.animations[0];t[0].name&&!u.name&&(u.name=t[0].name);function c(t,r,o){var i=a.endAccessor(),s=W(e,a.getIndex(),i),f=t.endAccessor(),c={input:s,output:W(e,t.getIndex(),f),interpolation:r},h={sampler:u.samplers.length,target:{node:n,path:o}};u.samplers.push(c),u.channels.push(h)}for(var p=0,d=t;p<d.length;p++){var y=d[p];if(y.keyframes&&0!=y.keyframes.length){var m=y.path,g=4===y.keyframes[0].value.length,v=void 0;g?(r||(r=s.addBufferView(h.FLOAT,l.VEC4)),v=r):(o||(o=s.addBufferView(h.FLOAT,l.VEC3)),v=o),a.startAccessor(),v.startAccessor();for(var _=y.keyframes[0].interpType,w=0,T=y.keyframes.length,x=0;x<T;++x){var E=y.keyframes[x],A=E.interpType;A!=_&&(c(v,_,m),a.startAccessor(),v.startAccessor(),w=0);var I=A===b.CUBICSPLINE;if(I&&g)throw new Error("CUBICSPLINE for Vector4 not implemented!");var O=E.time,S=E.value;if(a.push(O),I){var C=E.extras,N=[0,0,0],M=[0,0,0];(null==C?void 0:C.inTangent)&&w>0&&(M=C.inTangent),(null==C?void 0:C.outTangent)&&x<T-1&&y.keyframes[x+1].interpType===b.CUBICSPLINE&&(N=C.outTangent);for(var B=0,L=[M,S,N];B<L.length;B++)for(var R=L[B],z=0;z<3;++z)v.push(R[z])}else{var P=g?4:3;for(z=0;z<P;++z)v.push(S[z])}w++,_=A}c(v,_,m)}}a.finalize(),r&&r.finalize();o&&o.finalize();i||s.finalize()}(e,t.animations,a),t.mesh&&(r.mesh=function(e,t){e.meshes||(e.meshes=[]);if(t.mode!==p.TRIANGLES)throw"MeshMode other than TRIANGLES not currently supported";!function(e,t){for(var n=[],r=0,o=t;r<o.length;r++){var i=o[r];n.push(H(e,i))}}(e,t.material);var n={primitives:[]},r=e.meshes.length;e.meshes.push(n);var o,i=e.extras.options.bufferOutputType===f.GLB;o=i?e.extras.binChunkBuffer:Y(e);var s,a=o.addBufferView(h.FLOAT,l.VEC3),u=o.addBufferView(h.FLOAT,l.VEC3),c=o.addBufferView(h.FLOAT,l.VEC2);function d(n){var r=a.endAccessor(),o=u.endAccessor(),i=c.endAccessor(),f={attributes:{POSITION:W(e,a.getIndex(),r),NORMAL:W(e,u.getIndex(),o),TEXCOORD_0:W(e,c.getIndex(),i)},mode:t.mode};if(n>=0&&(f.material=n,t.material[n].vertexColorMode!==w.NoColors)){var h=s.endAccessor();f.attributes.COLOR_0=W(e,s.getIndex(),h)}return f}var y=null;if(t.forEachFace((function(e,r,i,f,p){var m=null;if(p>=0&&(m=t.material[p]),y!==p){if(null!==y){var g=d(y);n.primitives.push(g)}a.startAccessor("POSITION"),u.startAccessor("NORMAL"),c.startAccessor("TEXCOORD_0"),m&&m.vertexColorMode!==w.NoColors&&(!function(){if(s)return;s=o.addBufferView(h.UNSIGNED_BYTE,l.VEC4)}(),s.startAccessor("COLOR_0")),y=p}if(a.push(e.x),a.push(e.y),a.push(e.z),a.push(r.x),a.push(r.y),a.push(r.z),a.push(i.x),a.push(i.y),a.push(i.z),u.push(e.normalX),u.push(e.normalY),u.push(e.normalZ),u.push(r.normalX),u.push(r.normalY),u.push(r.normalZ),u.push(i.normalX),u.push(i.normalY),u.push(i.normalZ),c.push(e.u),c.push(e.v),c.push(r.u),c.push(r.v),c.push(i.u),c.push(i.v),m)switch(m.vertexColorMode){case w.FaceColors:for(var v=0;v<3;v++)j(s,f||new x);break;case w.VertexColors:j(s,e.color||new x),j(s,r.color||new x),j(s,i.color||new x)}})),null!==y){var m=d(y);n.primitives.push(m)}a.finalize(),u.finalize(),c.finalize(),s&&s.finalize();i||o.finalize();return r}(e,t.mesh)),t.forEachNode((function(t){r.children||(r.children=[]);var n=k(e,t);r.children.push(n)})),t.skin&&(r.skin=function(e,t,n){e.skins||(e.skins=[]);var r=e.skins.length,o={joints:[]};e.skins.push(o),t.name.length>0&&(o.name=t.name);var i=t.skeletonNode;if(i){var s=Q(e,i);o.skeleton=-1===s?k(e,i):s}var a=function e(t,n){var r=Q(t,n);if(-1===r)throw new Error("Node should be added to gltf before calling getJointIndexAndInverseBindMatrices");var o=[r],i=[n.inverseBindMatrix];return n.forEachNode((function(n){var r=e(t,n);o=o.concat(r[0]),i=i.concat(r[1])})),[o,i]}(e,i||n);o.joints=a[0];for(var u=a[1],c=!1,p=0,d=u;p<d.length;p++){if((T=d[p])&&4===T.rows&&4===T.cols&&!v.IsIdentity(T)){c=!0;break}}if(!c)return r;var y=e.extras.options.bufferOutputType===f.GLB,m=y?e.extras.binChunkBuffer:Y(e),g=m.addBufferView(h.FLOAT,l.MAT4);g.startAccessor();for(var _=0,w=u;_<w.length;_++)for(var b=w[_],T=b instanceof v?b:new v,x=0;x<4;x++)for(var E=0;E<4;E++)g.push(T.data[E][x]);var A=g.endAccessor(),I=W(e,g.getIndex(),A);o.inverseBindMatrices=I,g.finalize(),y||m.finalize();return r}(e,t.skin,t)),a}function j(e,t){e.push(255*t.r|0),e.push(255*t.g|0),e.push(255*t.b|0),"a"in t?e.push(255*t.a|0):e.push(255)}function Y(e){return new V(e)}function W(e,t,n){e.accessors||(e.accessors=[]);var r=e.accessors.length,o=n.componentType,i={bufferView:t,byteOffset:n.byteOffset,componentType:o,count:n.count,type:n.type,min:n.min,max:n.max};return n.normalized&&(i.normalized=!0),e.accessors.push(i),r}function H(e,t){e.materials||(e.materials=[]);var n={};if(t.name&&(n.name=t.name),t.alphaMode!==y.OPAQUE&&(n.alphaMode=t.alphaMode),.5!==t.alphaCutoff&&(n.alphaCutoff=t.alphaCutoff),t.doubleSided&&(n.doubleSided=!0),t.pbrMetallicRoughness&&(t.pbrMetallicRoughness.baseColorFactor&&(n.pbrMetallicRoughness={},n.pbrMetallicRoughness.baseColorFactor=t.pbrMetallicRoughness.baseColorFactor),t.pbrMetallicRoughness.baseColorTexture)){n.pbrMetallicRoughness||(n.pbrMetallicRoughness={});var r=function(e,t){e.textures||(e.textures=[]);var n={sampler:J(e,t),source:X(e,t.image)},r=e.textures.length;return e.textures.push(n),r}(e,t.pbrMetallicRoughness.baseColorTexture);n.pbrMetallicRoughness.baseColorTexture={index:r}}var o=e.materials.length;return e.materials.push(n),o}function X(e,t){e.images||(e.images=[]);for(var n=0;n<e.images.length;n++)if(t===e.images[n].extras)return n;var r,o={extras:t};switch(e.extras.options.imageOutputType){case c.GLB:(r=e.extras.binChunkBuffer.addBufferView(h.UNSIGNED_BYTE,l.SCALAR)).writeAsync(U(t)).then((function(){r.finalize()})),o.bufferView=r.getIndex(),o.mimeType="image/png";break;case c.DataURI:o.uri=function(e){return D(e).toDataURL()}(t);break;default:e.extras.promises.push(U(t).then((function(e){o.uri=e})))}var i=e.images.length;return e.images.push(o),i}function J(e,t){e.samplers||(e.samplers=[]);for(var n,r,o={wrapS:t.wrapS,wrapT:t.wrapT},i=0;i<e.samplers.length;i++)if(n=o,r=e.samplers[i],JSON.stringify(n)===JSON.stringify(r))return i;var s=e.samplers.length;return e.samplers.push(o),s}function Q(e,t){return e.extras.nodeIndices.has(t)?e.extras.nodeIndices.get(t):-1}var Z;function K(e,t){if(!e)throw new Error("GLB requires a JSON glTF chunk");var n=12;n+=8;var r=function(e){return(new TextEncoder).encode(e).buffer}(e);if(n+=$(r.byteLength,4),t&&(n+=8,n+=t.byteLength,t.byteLength%4))throw new Error("Expected BIN chunk length to be divisible by 4 at this point");var o=new ArrayBuffer(n),i=new DataView(o);!function(e,t){e.setUint32(0,1179937895,!0),e.setUint32(4,2,!0),e.setUint32(8,t,!0)}(i,n);var s=q(i,r,12,Z.JSON,32);return t&&q(i,t,s,Z.BIN),o}function q(e,t,n,r,o){void 0===o&&(o=0);var i,s,a,u,f,c=$(t.byteLength,4);for(e.setUint32(n,c,!0),e.setUint32(n+=4,r,!0),i=e.buffer,s=t,a=n+=4,u=0,f=t.byteLength,new Uint8Array(i,a,f).set(new Uint8Array(s,u,f),0),n+=t.byteLength;n%4;)o&&e.setUint8(n,o),n++;return n}function $(e,t){return t*Math.ceil(e/t)}!function(e){e[e.JSON=1313821514]="JSON",e[e.BIN=5130562]="BIN"}(Z||(Z={}));var ee=function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{u(r.next(e))}catch(e){i(e)}}function a(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((r=r.apply(e,t||[])).next())}))},te=function(e,t){var n,r,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,r=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}};function ne(e,t){return ee(this,void 0,void 0,(function(){var n,r,o,i,s;return te(this,(function(a){return t=t||{},(n={asset:{version:"2.0"},extras:{options:{},binChunkBuffer:null,promises:[],nodeIndices:new Map}}).asset.copyright=e.copyright,n.asset.generator=e.generator,n.extras.options=t,F(n,e),r=n.extras.promises,o=1,i=1,s=null,[2,Promise.all(r).then((function(){var e={};delete n.extras;var r="number"==typeof t.jsonSpacing?t.jsonSpacing:4,a=JSON.stringify(n,(function(n,r){if("extras"!==n){if(r instanceof ArrayBuffer){if(function(e){if(e.byteLength<8)return!1;var t=new Uint8Array(e);return 137===t[0]&&80===t[1]&&78===t[2]&&71===t[3]&&13===t[4]&&10===t[5]&&26===t[6]&&10===t[7]}(r))switch(t.imageOutputType){case c.DataURI:case c.GLB:break;default:var a="img"+i+".png";return i++,e[a]=r,a}switch(t.bufferOutputType){case f.DataURI:return function(e){for(var t=[],n=new Uint8Array(e),r=0;r<n.length;r++)t.push(String.fromCharCode(n[r]));return"data:application/octet-stream;base64,"+btoa(t.join(""))}(r);case f.GLB:if(s)throw new Error("Already encountered an ArrayBuffer, there should only be one in the GLB format.");return void(s=r);default:a="data"+o+".bin";return o++,e[a]=r,a}}return r}}),r);return t.bufferOutputType===f.GLB||t.imageOutputType===c.GLB?e["model.glb"]=K(a,s):e["model.gltf"]=a,e}))]}))}))}function re(e,t,n){return ee(this,void 0,void 0,(function(){return te(this,(function(r){return[2,ne(e,n).then((function(e){var n=new t;for(var r in e)n.file(r,e[r]);return n.generateAsync({type:"blob"})}))]}))}))}function oe(e){return ee(this,void 0,void 0,(function(){return te(this,(function(t){return[2,ne(e,{bufferOutputType:f.GLB,imageOutputType:c.GLB,jsonSpacing:0}).then((function(e){return e["model.glb"]}))]}))}))}}])}));